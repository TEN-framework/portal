---
title: åˆ›å»º ASR æ‰©å±•
description: ä»é›¶å¼€å§‹åˆ›å»ºã€å¼€å‘ã€æµ‹è¯•å¹¶å‘å¸ƒä¸€ä¸ªå®Œæ•´çš„ ASR æ‰©å±•
---

# åˆ›å»º ASR Extensionå®Œæ•´æŒ‡å—

æœ¬æ•™ç¨‹å°†æŒ‡å¯¼ä½ ä»é›¶å¼€å§‹åˆ›å»ºä¸€ä¸ªç”Ÿäº§çº§åˆ«çš„ ASRï¼ˆè‡ªåŠ¨è¯­éŸ³è¯†åˆ«ï¼‰ Extensionï¼Œæ¶µç›–ä»é¡¹ç›®åˆ›å»ºã€æ ¸å¿ƒå¼€å‘ã€æµ‹è¯•éªŒè¯åˆ°å‘å¸ƒä¸Šçº¿çš„å®Œæ•´æµç¨‹ã€‚

## ä»€ä¹ˆæ˜¯ ASR Extension

ASR Extension æ˜¯ TEN Framework ç”Ÿæ€ç³»ç»Ÿä¸­çš„ä¸€ä¸ª**æ ‡å‡†æ‰©å±•ç§¯æœ¨**ï¼ˆStandard Extensionï¼‰ï¼Œä¸“é—¨ç”¨äºå®ç°è‡ªåŠ¨è¯­éŸ³è¯†åˆ«ï¼ˆAutomatic Speech Recognitionï¼‰åŠŸèƒ½ã€‚

### æ ¸å¿ƒåŠŸèƒ½

ASR Extension çš„ä¸»è¦èŒè´£åŒ…æ‹¬ï¼š

1. **æ¥æ”¶éŸ³é¢‘æµ**: ä»ä¸Šæ¸¸æ‰©å±•æŒç»­æ¥æ”¶å®æ—¶éŸ³é¢‘æ•°æ®æµï¼ˆé€šå¸¸ä¸º PCM æ ¼å¼ï¼‰
2. **å®æ—¶è½¬å†™**: å°†éŸ³é¢‘æ•°æ®å®æ—¶è½¬æ¢æˆå¯¹åº”çš„æ–‡å­—ç»“æœ
3. **å‘é€ç»“æœ**: å°†è¯†åˆ«çš„æ–‡å­—ç»“æœä¼ é€’ç»™ä¸‹æ¸¸æ‰©å±•è¿›è¡Œåç»­å¤„ç†

### åœ¨å¯¹è¯æµä¸­çš„ä½ç½®

ä½œä¸ºæ ‡å‡†ç§¯æœ¨ï¼ŒASR Extension åœ¨ TEN Agent å¯¹è¯æµä¸­æ‰®æ¼”ç€**éŸ³é¢‘åˆ°æ–‡æœ¬è½¬æ¢**çš„å…³é”®è§’è‰²ï¼š

```
[ä¸Šæ¸¸ç§¯æœ¨]  â”€â”€éŸ³é¢‘æµâ”€â”€>  [ASR Extension]  â”€â”€æ–‡å­—æµâ”€â”€>  [ä¸‹æ¸¸ç§¯æœ¨]
```

**å…¸å‹çš„ä¸Šæ¸¸ç§¯æœ¨**ï¼š
- **RTC Extension**: ä» RTC é¢‘é“æ‹‰å–è¿œç«¯éŸ³é¢‘æµ
- **Audio Capture Extension**: ä»éº¦å…‹é£æˆ–éŸ³é¢‘æ–‡ä»¶è·å–éŸ³é¢‘æ•°æ®
- **Audio Processing Extension**: æä¾›ç»è¿‡é¢„å¤„ç†çš„éŸ³é¢‘æµï¼ˆå¦‚é™å™ªã€å›å£°æ¶ˆé™¤ç­‰ï¼‰

**å…¸å‹çš„ä¸‹æ¸¸ç§¯æœ¨**ï¼š
- **LLM Extension**: å°†è¯†åˆ«çš„æ–‡å­—ä½œä¸ºè¾“å…¥ï¼Œè¿›è¡Œå¯¹è¯ç†è§£å’Œç”Ÿæˆ
- **Translation Extension**: å¯¹è¯†åˆ«çš„æ–‡å­—è¿›è¡Œè·¨è¯­è¨€ç¿»è¯‘
- **Intent Recognition Extension**: æå–ç”¨æˆ·æ„å›¾å’Œå…³é”®ä¿¡æ¯

### å®é™…åº”ç”¨åœºæ™¯

**åœºæ™¯1: AI è¯­éŸ³å¯¹è¯åŠ©æ‰‹**
```
RTC Extension â†’ ASR Extension â†’ LLM Extension â†’ TTS Extension â†’ RTC Extension
```
ä» RTC é¢‘é“é‡‡é›†ç”¨æˆ·çš„è¯­éŸ³ï¼ŒASR å°†è¯­éŸ³è½¬å†™æˆæ–‡å­—ï¼ŒLLM ç†è§£è¯­ä¹‰å¹¶ç”Ÿæˆå›å¤ï¼ŒTTS å°†å›å¤è½¬æ¢æˆè¯­éŸ³åæ¨é€åˆ° RTC é¢‘é“ã€‚

**åœºæ™¯2: å®æ—¶è¯­éŸ³ç¿»è¯‘**
```
RTC Extension â†’ ASR Extension â†’ Translation Extension â†’ TTS Extension â†’ RTC Extension
```
é‡‡é›†ç”¨æˆ·çš„ä¸­æ–‡è¯­éŸ³ï¼ŒASR è¯†åˆ«æˆä¸­æ–‡æ–‡å­—ï¼ŒTranslation ç§¯æœ¨è½¬æ¢æˆç›®æ ‡è¯­è¨€ï¼ˆå¦‚è‹±æ–‡ï¼‰ï¼ŒTTS å°†è¯‘æ–‡è½¬æ¢æˆè¯­éŸ³è¾“å‡ºã€‚

**åœºæ™¯3: è¯­éŸ³æ™ºèƒ½æ§åˆ¶**
```
Microphone Extension â†’ ASR Extension â†’ Intent Recognition Extension â†’ Action Executor Extension
```
é€šè¿‡éº¦å…‹é£é‡‡é›†è¯­éŸ³æŒ‡ä»¤ï¼ŒASR è½¬å†™æˆæ–‡å­—ï¼ŒIntent Recognition æå–æ§åˆ¶æ„å›¾ï¼ŒAction Executor æ‰§è¡Œç›¸åº”çš„è®¾å¤‡æ§åˆ¶åŠ¨ä½œã€‚

### æ ‡å‡†åŒ– ASR Extension çš„æ„ä¹‰

å°† ASR åŠŸèƒ½å°è£…æˆæ ‡å‡†æ‰©å±•ç§¯æœ¨ï¼Œå¸¦æ¥ä»¥ä¸‹æ ¸å¿ƒä»·å€¼ï¼š

- **ğŸ”Œ å³æ’å³ç”¨**: è½»æ¾åˆ‡æ¢ä¸åŒçš„ ASR æœåŠ¡å•†ï¼ˆDeepgramã€Azureã€Google ç­‰ï¼‰ï¼Œæ— éœ€ä¿®æ”¹ä¸Šä¸‹æ¸¸ç§¯æœ¨
- **ğŸ”„ çµæ´»ç»„åˆ**: ä¸å…¶ä»–æ ‡å‡†ç§¯æœ¨è‡ªç”±ç»„åˆï¼Œå¿«é€Ÿæ„å»ºå„ç±» AI åº”ç”¨åœºæ™¯
- **ğŸ› ï¸ æ˜“äºç»´æŠ¤**: ç‹¬ç«‹å¼€å‘ã€æµ‹è¯•ã€å‡çº§ï¼Œä¸å½±å“å…¶ä»–ç§¯æœ¨çš„ç¨³å®šæ€§
- **ğŸ“¦ é«˜åº¦å¤ç”¨**: ä¸€æ¬¡å¼€å‘ï¼Œå¤šä¸ªé¡¹ç›®å¤ç”¨ï¼Œæ˜¾è‘—æå‡å¼€å‘æ•ˆç‡
- **ğŸŒ ç”Ÿæ€å…±äº«**: å‘å¸ƒåˆ° TEN Storeï¼Œè®©å…¨çƒå¼€å‘è€…å—ç›Š

## ğŸ“‹ ä½ å°†å­¦åˆ°ä»€ä¹ˆ

- ğŸš€ ä½¿ç”¨ ASR æ¨¡æ¿å¿«é€Ÿåˆ›å»ºæ‰©å±•é¡¹ç›®
- âš™ï¸ ç†è§£ ASR Extension æ¥å£è§„èŒƒ  
- ğŸ”§ å®ç° ASR Extension æ ¸å¿ƒåŠŸèƒ½
- ğŸ§ª ç¼–å†™å…¨é¢çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
- ğŸ“Š æŒæ¡æ—¥å¿—è®°å½•ã€é”™è¯¯å¤„ç†ç­‰æœ€ä½³å®è·µ
- ğŸŒ å‘å¸ƒæ‰©å±•åˆ° TEN Store ä¾›ç¤¾åŒºä½¿ç”¨

## ğŸ“š å‰ç½®æ¡ä»¶

å¼€å§‹æœ¬æ•™ç¨‹å‰ï¼Œè¯·ç¡®ä¿ä½ å·²å…·å¤‡ï¼š

- **åŸºç¡€çŸ¥è¯†**: ç†Ÿæ‚‰ [TEN Agent æ¶æ„](/docs/ten_agent/getting_started) å’Œ ASR æœåŠ¡åŸºæœ¬æ¦‚å¿µ
- **æŠ€æœ¯èƒ½åŠ›**: æŒæ¡ Python å¼‚æ­¥ç¼–ç¨‹ï¼ˆ`asyncio`ã€`async/await`ï¼‰
- **å¼€å‘ç¯å¢ƒ**: åœ¨å¼€å‘å®¹å™¨å†…å¼€å‘ï¼ˆå®‰è£…å¥½tmanï¼‰
- **API èµ„æº**: å‡†å¤‡å¥½ ASR æœåŠ¡å•†çš„ API å¯†é’¥ï¼ˆç”¨äºæµ‹è¯•éªŒè¯ï¼‰

<Callout type="info">
  **ç¤ºä¾‹è¯´æ˜**: æœ¬æ•™ç¨‹ä»¥ Deepgram ASR ä¸ºä¾‹è¿›è¡Œè®²è§£ï¼Œä½†æ‰€ä»‹ç»çš„æ–¹æ³•å’Œæ¨¡å¼åŒæ ·é€‚ç”¨äºå…¶ä»– ASR æœåŠ¡å•†æˆ–è€…æœ¬åœ°ASRæ¨¡å‹ã€‚
</Callout>

## 1. ğŸš€ é¡¹ç›®åˆå§‹åŒ–

### åˆ›å»ºæ‰©å±•é¡¹ç›®

ä½¿ç”¨ TMan çš„ ASR ä¸“ç”¨æ¨¡æ¿å¿«é€Ÿåˆ›å»ºé¡¹ç›®éª¨æ¶ï¼š

```bash title="Terminal"
# è¿›å…¥æ‰©å±•ç›®å½•
cd ten-framework/ai_agents/agents/ten_packages/extension

# åˆ›å»ºASRæ‰©å±•é¡¹ç›®
tman create extension my_asr_extension --template default_asr_python --template-data class_name_prefix=MyAsr
```

åˆ›å»ºæˆåŠŸåä¼šæ˜¾ç¤ºï¼š

```bash title="è¾“å‡ºä¿¡æ¯"
Package 'extension:my_asr_extension' created successfully in 'my_asr_extension' in 2 seconds.
```

### å®‰è£…é¡¹ç›®ä¾èµ–

#### æ·»åŠ ç¬¬ä¸‰æ–¹åº“ä¾èµ–

é¦–å…ˆåœ¨ `requirements.txt` ä¸­æ·»åŠ  Deepgram SDKï¼š

```text title="requirements.txt"
websockets~=14.0
pydantic
requests
deepgram-sdk
aiofiles
```

#### å®‰è£… TEN ä¾èµ–

è¿›å…¥åˆ›å»ºçš„æ‰©å±•ç›®å½•å¹¶å®‰è£…ä¾èµ–ï¼š

```bash title="Terminal"
cd my_asr_extension
tman install --standalone
```

è¿™ä¼šæ ¹æ® `manifest.json` ä¸­å£°æ˜çš„ä¾èµ–æ„å»ºä¾èµ–æ ‘ï¼Œå¹¶å®‰è£…åˆ° `.ten` ç›®å½•ä¸‹ã€‚

## 2. ğŸ—ï¸ æ‰©å±•æ¶æ„è®¾è®¡

### é¡¹ç›®ç»“æ„æ¦‚è§ˆ

```
my_asr_extension/
â”œâ”€â”€ .vscode/               # VS Code è°ƒè¯•é…ç½®
â”‚   â””â”€â”€ launch.json       # è°ƒè¯•å¯åŠ¨é…ç½®
â”œâ”€â”€ manifest.json          # æ‰©å±•å…ƒæ•°æ®å’Œä¾èµ–å£°æ˜
â”œâ”€â”€ property.json          # é»˜è®¤é…ç½®å‚æ•°  
â”œâ”€â”€ requirements.txt       # Python ä¾èµ–
â”œâ”€â”€ extension.py           # ä¸»è¦å®ç°æ–‡ä»¶
â””â”€â”€ tests/                 # æµ‹è¯•æ–‡ä»¶
    â”œâ”€â”€ bin/start         # æµ‹è¯•å¯åŠ¨è„šæœ¬
    â”œâ”€â”€ test_basic.py     # å•å…ƒæµ‹è¯•
    â””â”€â”€ configs/          # æµ‹è¯•é…ç½®
```

### ASR Extension æ¥å£è§„èŒƒ

ASR Extension éµå¾ª TEN Framework çš„æ ‡å‡†æ¥å£è§„èŒƒã€‚ä½¿ç”¨æ¨¡æ¿åˆ›å»ºçš„ ASR Extension ä¼šè‡ªåŠ¨é…ç½®å¥½æ¥å£ç»§æ‰¿å…³ç³»å’Œå¿…è¦çš„ API å£°æ˜ã€‚

#### Manifest é…ç½®

ASR Extension çš„ `manifest.json` æ–‡ä»¶ä¸­éœ€è¦æ­£ç¡®é…ç½®æ¥å£å’Œå±æ€§å£°æ˜ï¼š

**1. Interface ç»§æ‰¿**

åœ¨ `manifest.json` çš„ `api.interface` ä¸­å£°æ˜ç»§æ‰¿è‡ª `ten_ai_base` ç³»ç»ŸåŒ…ä¸‹çš„æ ‡å‡† ASR æ¥å£ï¼š

```json title="manifest.json"
{
  "api": {
    "interface": [
      {
        "import_uri": "../../system/ten_ai_base/api/asr-interface.json"
      }
    ]
  }
}
```

è¯¥æ¥å£æ–‡ä»¶ï¼ˆ`asr-interface.json`ï¼‰ä¸­å®šä¹‰äº†æ‰€æœ‰ ASR Extension å¿…é¡»éµå¾ªçš„æ ‡å‡†å±æ€§ï¼ŒåŒ…æ‹¬ï¼š
- `dump`: å¸ƒå°”å€¼ï¼Œé…ç½®æ˜¯å¦å¼€å¯éŸ³é¢‘ dump
- `dump_path`: å­—ç¬¦ä¸²ï¼ŒéŸ³é¢‘ dump çš„å­˜å‚¨è·¯å¾„

**2. Property å£°æ˜**

é™¤äº†ç»§æ‰¿æ ‡å‡†æ¥å£å¤–ï¼Œæ¯ä¸ª ASR Extension è¿˜éœ€è¦åœ¨ `api.property` ä¸­å£°æ˜è‡ªå·±ç‰¹æœ‰çš„é…ç½®å±æ€§ï¼Œç‰¹åˆ«æ˜¯ `params` å¯¹è±¡ä¸­çš„å¿…å¡«å­—æ®µã€‚

ä¾‹å¦‚å¦‚ä¸‹é…ç½®ï¼š

```json title="manifest.json"
{
  "api": {
    "interface": [
      {
        "import_uri": "../../system/ten_ai_base/api/asr-interface.json"
      }
    ],
    "property": {
      "properties": {
        "params": {
          "type": "object",
          "properties": {
            "key": {
              "type": "string"
            },
            "region": {
              "type": "string"
            },
            "language": {
              "type": "string"
            }
          }
        }
      }
    }
  }
}
```

**å…³é”®è¯´æ˜**ï¼š
- **æ ‡å‡†å±æ€§**ï¼ˆå¦‚ `dump`ã€`dump_path`ï¼‰ï¼šé€šè¿‡ `interface` ç»§æ‰¿è‡ª `asr-interface.json`ï¼Œæ‰€æœ‰ ASR Extension å…±æœ‰
- **æ‰©å±•å±æ€§**ï¼ˆå¦‚ `params.key`ã€`params.language`ï¼‰ï¼šåœ¨ `api.property` ä¸­å£°æ˜ï¼Œæ ¹æ®ä¸åŒçš„ ASR æœåŠ¡å•†è€Œå¼‚

ä½¿ç”¨æ¨¡æ¿åˆ›å»º ASR Extension æ—¶ï¼Œè¿™äº›é…ç½®ä¼šè‡ªåŠ¨ç”Ÿæˆï¼Œä½†éœ€è¦æ ¹æ®å®é™…çš„æœåŠ¡å•†éœ€æ±‚è°ƒæ•´ `params` ä¸­çš„å±æ€§ã€‚

#### è¾“å…¥è¾“å‡ºæ•°æ®æ ¼å¼

ASR æ ‡å‡†æ¥å£ï¼ˆ`asr-interface.json`ï¼‰ä¸­é™¤äº†å±æ€§é…ç½®å¤–ï¼Œè¿˜å®šä¹‰äº†è¾“å…¥å’Œè¾“å‡ºçš„æ•°æ®æ ¼å¼è§„èŒƒï¼š

**è¾“å…¥æ•°æ®**ï¼š
- **PCM éŸ³é¢‘å¸§** (`pcm_frame`): ä»ä¸Šæ¸¸æ¥æ”¶çš„éŸ³é¢‘æ•°æ®æµ
- **Finalize äº‹ä»¶** (`asr_finalize`): VAD æ£€æµ‹åˆ°äººå£°ç»“æŸæ—¶è§¦å‘

**è¾“å‡ºæ•°æ®**ï¼š
- **è¯†åˆ«ç»“æœ** (`asr_result`): ASR è½¬å†™çš„æ–‡å­—ç»“æœ
- **Finalize å®Œæˆé€šçŸ¥** (`asr_finalize_end`): Finalize å¤„ç†å®Œæˆçš„é€šçŸ¥
- **é”™è¯¯ä¿¡æ¯** (`error`): å‘ç”Ÿé”™è¯¯æ—¶çš„é”™è¯¯è¯¦æƒ…
- **æ€§èƒ½æŒ‡æ ‡** (`metrics`): TTFWã€TTLW ç­‰æ€§èƒ½æ•°æ®

è¯¦ç»†çš„æ•°æ®ç»“æ„å®šä¹‰å’Œå­—æ®µè¯´æ˜è¯·å‚è€ƒ `asr-interface.json` æ–‡ä»¶ã€‚

### æ ¸å¿ƒç»§æ‰¿å…³ç³»

```python
AsyncASRBaseExtension  # TEN AI Base æä¾›çš„æŠ½è±¡åŸºç±»
    â†“
MyAsrExtension         # ä½ çš„å…·ä½“å®ç°
```

#### åŸºç±»åŠŸèƒ½æ¦‚è¿°

`AsyncASRBaseExtension` æ˜¯ TEN AI Base æä¾›çš„ ASR æ‰©å±•æŠ½è±¡åŸºç±»ï¼Œå®ƒä¸ºæ‰€æœ‰ ASR Extension æä¾›äº†ç»Ÿä¸€çš„æ¡†æ¶å’Œå¼€ç®±å³ç”¨çš„åŠŸèƒ½ï¼š

**æ ¸å¿ƒèŒè´£**ï¼š

1. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šè‡ªåŠ¨å¤„ç†æ‰©å±•çš„åˆå§‹åŒ–ã€å¯åŠ¨ã€åœæ­¢ç­‰ç”Ÿå‘½å‘¨æœŸäº‹ä»¶
2. **éŸ³é¢‘å¸§å¤„ç†**ï¼š
   - æ¥æ”¶ä¸Šæ¸¸çš„éŸ³é¢‘å¸§å¹¶æ”¾å…¥å¼‚æ­¥é˜Ÿåˆ—
   - æ ¹æ®è¿æ¥çŠ¶æ€è‡ªåŠ¨æ‰§è¡Œç¼“å†²ç­–ç•¥ï¼ˆä¸¢å¼ƒæˆ–ä¿æŒï¼‰
   - æå–å’Œç®¡ç† session_idã€metadata ç­‰å…ƒä¿¡æ¯
3. **Finalize äº‹ä»¶å¤„ç†**ï¼šæ¥æ”¶ `asr_finalize` æ•°æ®ï¼Œè°ƒç”¨å­ç±»çš„ `finalize()` æ–¹æ³•
4. **æ€§èƒ½æŒ‡æ ‡è‡ªåŠ¨è®¡ç®—**ï¼š
   - TTFWï¼ˆTime To First Wordï¼‰ï¼šé¦–è¯å»¶è¿Ÿ
   - TTLWï¼ˆTime To Last Wordï¼‰ï¼šæœ«è¯å»¶è¿Ÿ
   - éŸ³é¢‘å‘é€æ—¶é•¿ç»Ÿè®¡å’Œå®šæœŸä¸ŠæŠ¥
5. **æ ‡å‡†åŒ–è¾“å‡º**ï¼šæä¾›ç»Ÿä¸€çš„ API å‘é€è¯†åˆ«ç»“æœã€é”™è¯¯ä¿¡æ¯ã€æ€§èƒ½æŒ‡æ ‡ç­‰æ•°æ®
6. **ä¼šè¯ç®¡ç†**ï¼šè‡ªåŠ¨ä¸ºæ¯è½®å¯¹è¯ç”Ÿæˆå”¯ä¸€ IDï¼Œç®¡ç† metadata ä¼ é€’

é€šè¿‡ç»§æ‰¿åŸºç±»ï¼Œå¼€å‘è€…åªéœ€ä¸“æ³¨äºå®ç°ä¸å…·ä½“ ASR æœåŠ¡å•†äº¤äº’çš„æ ¸å¿ƒé€»è¾‘ï¼Œæ— éœ€å…³å¿ƒæ¡†æ¶å±‚çš„é€šç”¨å¤„ç†ã€‚

#### å¿…é¡»å®ç°çš„æŠ½è±¡æ–¹æ³•

- `vendor()`: è¿”å› ASR æœåŠ¡å•†åç§°
- `start_connection()`: å»ºç«‹ä¸ ASR æœåŠ¡çš„è¿æ¥
- `stop_connection()`: åœæ­¢è¿æ¥
- `send_audio(frame: AudioFrame, session_id: str | None) -> bool`: å‘é€éŸ³é¢‘æ•°æ®ï¼Œè¿”å›æ˜¯å¦æˆåŠŸ
- `finalize(session_id: str | None)`: å¿«é€Ÿè§¦å‘æœ€ç»ˆç»“æœï¼ˆVADæ£€æµ‹åˆ°äººå£°ç»“æŸåï¼Œé€šè¿‡æ–­è¿ã€å‘é€é™éŸ³åŒ…æˆ–ä¾›åº”å•†ä¸“ç”¨APIå¿«é€Ÿè·å¾—finalç»“æœï¼Œé™ä½å¯¹è¯å»¶è¿Ÿï¼‰
- `is_connected() -> bool`: æ£€æŸ¥è¿æ¥çŠ¶æ€
- `input_audio_sample_rate() -> int`: è¿”å›éŸ³é¢‘é‡‡æ ·ç‡ï¼ˆHzï¼‰

#### å¯é€‰å®ç°çš„æ–¹æ³•

- `input_audio_channels() -> int`: éŸ³é¢‘å£°é“æ•°ï¼ˆé»˜è®¤1å£°é“ï¼‰
- `input_audio_sample_width() -> int`: é‡‡æ ·ä½å®½ï¼ˆé»˜è®¤2å­—èŠ‚/16ä½ï¼‰
- `buffer_strategy() -> ASRBufferConfig`: éŸ³é¢‘ç¼“å†²ç­–ç•¥ï¼ˆé»˜è®¤ä¸¢å¼ƒæ¨¡å¼ï¼‰
- `audio_actual_send_metrics_interval() -> int`: éŸ³é¢‘æ—¶é•¿æŒ‡æ ‡ä¸ŠæŠ¥é—´éš”ï¼ˆé»˜è®¤5ç§’ï¼‰

#### åŸºç±»æä¾›çš„å·¥å…·æ–¹æ³•

- `send_asr_result(asr_result: ASRResult)`: å‘é€è¯†åˆ«ç»“æœ
- `send_asr_error(error: ModuleError, vendor_info: ModuleErrorVendorInfo | None)`: å‘é€é”™è¯¯ä¿¡æ¯
- `send_asr_finalize_end()`: å‘é€ finalize å®Œæˆé€šçŸ¥
- `send_connect_delay_metrics(connect_delay: int)`: å‘é€è¿æ¥å»¶è¿ŸæŒ‡æ ‡
- `send_vendor_metrics(vendor_metrics: dict)`: å‘é€ä¾›åº”å•†è‡ªå®šä¹‰æŒ‡æ ‡

## 3. âš™ï¸ é…ç½®ç®¡ç†è®¾è®¡

### è®¾è®¡é…ç½®ç±»

åˆ›å»ºçµæ´»çš„é…ç½®ç±»ï¼Œæ”¯æŒå¿…å¡«å‚æ•°å’Œå¯é€‰é€ä¼ å‚æ•°ï¼š

```python title="extension.py"
from pydantic import BaseModel
from typing import Dict, Optional

class MyAsrConfig(BaseModel):
    # æ‰€æœ‰ASRå‚æ•°éƒ½åœ¨paramsä¸­ï¼ŒåŒ…æ‹¬å¿…å¡«å’Œå¯é€‰å‚æ•°
    params: Dict[str, Optional[str]] = {}
    
    # éŸ³é¢‘dumpç›¸å…³é…ç½® - æ‰€æœ‰ASRæ‰©å±•çš„æ ‡å‡†å®ç°
    dump: bool = False
    dump_path: Optional[str] = None
```

### è¯»å–æ‰©å±•é…ç½®

åœ¨ `on_init` é˜¶æ®µè¯»å–å’Œåˆå§‹åŒ–é…ç½®ï¼š

```python title="extension.py"
from ten_ai_base.const import LOG_CATEGORY_KEY_POINT, LOG_CATEGORY_VENDOR
from ten_ai_base.message import ModuleError, ModuleErrorCode

@override
async def on_init(self, ten_env: AsyncTenEnv) -> None:
    await super().on_init(ten_env)
    
    # è¯»å–å®Œæ•´çš„æ‰©å±•é…ç½®
    config_json, _ = await ten_env.get_property_to_json("")
    
    try:
        # ååºåˆ—åŒ–é…ç½®ä¸ºé…ç½®ç±»å®ä¾‹
        self.config = MyAsrConfig.model_validate_json(config_json)
        
        # æ‰“å°é…ç½®ä¿¡æ¯ï¼ˆæ•æ„Ÿä¿¡æ¯è„±æ•ï¼‰
        ten_env.log_info(
            f"config: {self.config.to_json(sensitive_handling=True)}",
            category=LOG_CATEGORY_KEY_POINT,
        )
        
        # åˆå§‹åŒ–éŸ³é¢‘ dumperï¼ˆå¦‚æœå¼€å¯ï¼‰
        if self.config.dump:
            dump_file_path = os.path.join(
                self.config.dump_path, DUMP_FILE_NAME
            )
            self.audio_dumper = Dumper(dump_file_path)
            
    except Exception as e:
        ten_env.log_error(
            f"invalid property: {e}",
            category=LOG_CATEGORY_KEY_POINT
        )
        # é…ç½®é”™è¯¯æ—¶ä½¿ç”¨é»˜è®¤é…ç½®
        self.config = MyAsrConfig.model_validate_json("{}")
        # å‘é€è‡´å‘½é”™è¯¯
        await self.send_asr_error(
            ModuleError(
                module=MODULE_NAME_ASR,
                code=ModuleErrorCode.FATAL_ERROR.value,
                message=str(e),
            ),
        )
```

### é…ç½®æ•æ„Ÿä¿¡æ¯è„±æ•

ä¸ºé…ç½®ç±»æ·»åŠ è„±æ•æ–¹æ³•ï¼Œä¿æŠ¤æ•æ„Ÿä¿¡æ¯ï¼š

```python title="extension.py"
from ten_ai_base.utils import encrypt

class MyAsrConfig(BaseModel):
    params: Dict[str, Optional[str]] = {}
    dump: bool = False
    dump_path: Optional[str] = None
    
    def to_json(self, sensitive_handling: bool = False) -> str:
        """
        åºåˆ—åŒ–é…ç½®ä¸º JSONï¼Œæ”¯æŒæ•æ„Ÿä¿¡æ¯è„±æ•
        
        Args:
            sensitive_handling: æ˜¯å¦å¯¹æ•æ„Ÿä¿¡æ¯è¿›è¡Œè„±æ•å¤„ç†
        """
        if not sensitive_handling:
            return self.model_dump_json()
        
        # æ·±æ‹·è´é…ç½®å¯¹è±¡
        config = self.model_copy(deep=True)
        
        # å¯¹ params ä¸­çš„æ•æ„Ÿå­—æ®µè¿›è¡Œè„±æ•
        if config.params:
            encrypted_params = {}
            for key, value in config.params.items():
                # å¯¹åŒ…å« 'key'ã€'token'ã€'secret' ç­‰æ•æ„Ÿè¯çš„å­—æ®µè¿›è¡ŒåŠ å¯†
                if (key in ['api_key', 'key', 'token', 'secret', 'password'] 
                    and isinstance(value, str) and value):
                    encrypted_params[key] = encrypt(value)
                else:
                    encrypted_params[key] = value
            config.params = encrypted_params
            
        return config.model_dump_json()
```

### é…ç½®é»˜è®¤å‚æ•°

åœ¨ `property.json` ä¸­æä¾›é»˜è®¤é…ç½®ï¼š

```json title="property.json"
{
  "params": {
    "url": "wss://api.deepgram.com/v1/listen",
    "api_key": "your_deepgram_api_key_here",
    "language": "en",
    "model": "nova-2", 
    "sample_rate": "16000",
    "punctuate": "true",
    "smart_format": "true",
    "interim_results": "true"
  },
  "dump": false,
  "dump_path": "/tmp/asr_audio_dump"
}
```

## 4. ğŸ”§ æ ¸å¿ƒåŠŸèƒ½å®ç°

### å®ç°åŸºç¡€æ–¹æ³•

```python title="extension.py"
import asyncio
from deepgram import (
    DeepgramClient,
    DeepgramClientOptions, 
    LiveTranscriptionEvents,
    LiveOptions
)
from ten_ai_base.asr import ASRResult

class MyAsrExtension(AsyncASRBaseExtension):
    def __init__(self, name: str):
        super().__init__(name)
        self.config: MyAsrConfig = MyAsrConfig()
        self.deepgram_client: Optional[AsyncListenWebSocketClient] = None
        self.is_connected_flag: bool = False
        self.last_finalize_timestamp: float = 0.0  # ç”¨äºå»¶è¿Ÿè®¡ç®—
        
    @override
    def vendor(self) -> str:
        """è¿”å›ASRæœåŠ¡å•†åç§°"""
        return "deepgram"
    
    @override
    def input_audio_sample_rate(self) -> int:
        """è¿”å›éŸ³é¢‘é‡‡æ ·ç‡"""
        return int(self.config.params.get("sample_rate", 16000) or 16000)
    
    @override
    def is_connected(self) -> bool:
        """æ£€æŸ¥è¿æ¥çŠ¶æ€"""
        return self.is_connected_flag
```

### å®ç°è¿æ¥ç®¡ç†

#### å»ºç«‹è¿æ¥

start_connection ä¼š**åœ¨extensionåˆå§‹åŒ–å®Œæˆåè‡ªåŠ¨æ‰§è¡Œ**ï¼Œç”¨äºå’Œä¾›åº”å•†å»ºç«‹è¿æ¥ï¼Œç›‘å¬ä¾›åº”å•†è¿”å›çš„ç»“æœã€‚
åœ¨start_connectionä¸­å¦‚æœé‡åˆ°é”™è¯¯ï¼Œè¦èƒ½**æ‰“å°åŒ…å«é”™è¯¯ä¿¡æ¯çš„æ—¥å¿—**ï¼Œå¹¶ä¸”é€šè¿‡**send_asr_error**ä¸ŠæŠ¥é”™è¯¯ã€‚
å¦‚æœæ˜¯å¯ä»¥é€šè¿‡é‡è¯•è§£å†³çš„é”™è¯¯ï¼Œè¦é€šè¿‡**é‡è¯•æœºåˆ¶**è§£å†³ã€‚

```python title="extension.py"
@override
async def start_connection(self) -> None:
    """å»ºç«‹ä¸Deepgramçš„WebSocketè¿æ¥"""
    try:
        # ç¡®ä¿æ¸…ç†ä¹‹å‰çš„è¿æ¥
        await self.stop_connection()
        
        # åˆ›å»ºDeepgramå®¢æˆ·ç«¯é…ç½®
        config = DeepgramClientOptions(
            api_key=self.config.params.get("api_key", "") or ""
        )
        
        # åˆå§‹åŒ–WebSocketå®¢æˆ·ç«¯
        deepgram = DeepgramClient(config=config)
        self.deepgram_client = deepgram.listen.live.v("1")
        
        # æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
        await self._register_deepgram_events()
        
        # åˆ›å»ºè¿æ¥é€‰é¡¹
        options = LiveOptions(
            model=self.config.params.get("model", "nova-2") or "nova-2",
            language=self.config.params.get("language", "en") or "en",
            sample_rate=self.config.params.get("sample_rate", 16000) or 16000,
        )
        
        # é€ä¼ å…¶ä»–å‚æ•°
        for key, value in self.config.params.items():
            if key not in ["url", "api_key", "language", "model", "sample_rate"] and value:
                setattr(options, key, value == "true" if value in ["true", "false"] else value)
        
        # å¯åŠ¨è¿æ¥
        await self.deepgram_client.start(options)
        
    except Exception as e:
        self.ten_env.log_error(f"failed to connect to deepgram: {e}", category=LOG_CATEGORY_VENDOR)
        await self.send_asr_error(
            ModuleError(
                module=MODULE_NAME_ASR,
                code=ModuleErrorCode.FATAL_ERROR.value,
                message=str(e),
            ),
        )
```
#### åœæ­¢è¿æ¥

stop_connection ä¼š**åœ¨extensioné”€æ¯å‰è‡ªåŠ¨æ‰§è¡Œ**ï¼Œç”¨äºå’Œä¾›åº”å•†æ–­å¼€è¿æ¥ã€‚

```python title="extension.py"
@override
async def stop_connection(self) -> None:
    """åœæ­¢Deepgramè¿æ¥"""
    if self.deepgram_client:
        await self.deepgram_client.finish()
        self.deepgram_client = None
        self.is_connected_flag = False
```

### å®ç°éŸ³é¢‘å¤„ç†

asr extension æ”¶åˆ°ä¸Šæ¸¸extensionå‘æ¥çš„éŸ³é¢‘æ•°æ®åï¼ŒæœŸæœ›èƒ½**æµå¼**å‘é€ç»™asrä¾›åº”å•†/asræ¨¡å‹ï¼Œå¹¶ä¸”**æµå¼**è·å–asrç»“æœã€‚
asr base class åœ¨æ”¶åˆ°audio frameåä¼šæ ¹æ®å½“å‰çš„ is_connected çŠ¶æ€æ¥å†³å®šæ˜¯å¦è¦è°ƒç”¨send_audioæ–¹æ³•å‘ç»™ä¾›åº”å•†æˆ–æ˜¯ä¸¢æ‰/ç¼“å­˜ã€‚

```python title="extension.py"
@override
async def send_audio(self, audio_frame: AudioFrame) -> bool:
    """å‘é€éŸ³é¢‘æ•°æ®åˆ°ASRæœåŠ¡"""
    if not self.is_connected() or not self.deepgram_client:
        return False
        
    try:
        # è·å–éŸ³é¢‘æ•°æ®
        audio_buf = audio_frame.get_buf()
        if not audio_buf:
            return False
            
        # å‘é€åˆ°Deepgram
        await self.deepgram_client.send(bytes(audio_buf))
        return True
        
    except Exception as e:
        self.ten_env.log_error(f"Failed to send audio: {e}", category="vendor")
        return False
```

#### é…ç½®éŸ³é¢‘ç¼“å†²ç­–ç•¥

asr base class åœ¨æ”¶åˆ° audio frame åä¼šæ ¹æ®å½“å‰çš„ `is_connected` çŠ¶æ€æ¥å†³å®šæ˜¯å¦è¦è°ƒç”¨ `send_audio` æ–¹æ³•å‘ç»™ä¾›åº”å•†ï¼Œæˆ–æ˜¯ä¸¢æ‰/ç¼“å­˜éŸ³é¢‘å¸§ã€‚

åŸºç±»æä¾›ä¸¤ç§éŸ³é¢‘ç¼“å†²ç­–ç•¥ï¼Œé€šè¿‡å®ç° `buffer_strategy()` æ–¹æ³•é…ç½®ï¼š

**1. ä¸¢å¼ƒæ¨¡å¼** (`ASRBufferConfigModeDiscard`)ï¼š
- è¿æ¥æ–­å¼€æ—¶ç›´æ¥ä¸¢å¼ƒéŸ³é¢‘å¸§
- é€‚ç”¨äºå®æ—¶æ€§è¦æ±‚é«˜çš„åœºæ™¯

**2. ä¿æŒæ¨¡å¼** (`ASRBufferConfigModeKeep`)ï¼š
- è¿æ¥æ–­å¼€æ—¶ç¼“å­˜éŸ³é¢‘å¸§ï¼Œè¿æ¥æ¢å¤åå‘é€
- é€šè¿‡ `byte_limit` æ§åˆ¶ç¼“å­˜å¤§å°
- é€‚ç”¨äºéœ€è¦å®Œæ•´éŸ³é¢‘å¤„ç†çš„åœºæ™¯

```python title="extension.py"
from ten_ai_base.asr import ASRBufferConfig, ASRBufferConfigModeKeep

@override
def buffer_strategy(self) -> ASRBufferConfig:
    """é…ç½®éŸ³é¢‘ç¼“å†²ç­–ç•¥"""
    return ASRBufferConfig(
        mode=ASRBufferConfigModeKeep(byte_limit=10 * 1024 * 1024)  # 10MB ç¼“å­˜ä¸Šé™
    )
```

**æ¨èä½¿ç”¨ä¿æŒæ¨¡å¼**ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ—¶é—´æˆ³è®¡ç®—çš„å‡†ç¡®æ€§ï¼Œé¿å…å› ä¸ºä¸¢éŸ³é¢‘å¯¼è‡´æ—¶é—´æˆ³åå°ï¼Œå½±å“å¯¹è¯æ•ˆæœã€‚

#### å®ç° finalize æ–¹æ³•

finalize ä¼š**åœ¨VADæ£€æµ‹åˆ°äººå£°ç»“æŸåè‡ªåŠ¨æ‰§è¡Œ**ï¼Œç”¨äºè§¦å‘ASRæœåŠ¡è¿”å›finalç»“æœã€‚

tips: 
- å¦‚æœæ˜ç¡®finalizeå®Œæˆçš„æ—¶é—´ç‚¹ï¼Œéœ€è¦è°ƒç”¨send_asr_finalize_endæ¥é€šçŸ¥finalizeå®Œæˆã€‚
- å¦‚æœæ˜¯é€šè¿‡æ–­è¿æ–¹å¼æ¥å®ç°finalizeï¼Œè¦å¤„ç†å¥½é‡è¿é€»è¾‘ã€‚
- å¦‚æœæ˜¯é€šè¿‡é€é™éŸ³åŒ…æ–¹å¼æ¥å®ç°finalizeï¼Œè¦æ³¨æ„æ—¶é—´æˆ³çš„è®¡ç®—ï¼ˆè¿”å›çš„asrç»“æœé‡Œçš„æ—¶é—´æˆ³å¯èƒ½åŒ…å«é™éŸ³åŒ…çš„æ—¶é•¿ï¼Œè¦èƒ½å¤Ÿæ­£ç¡®å»é™¤ï¼‰ã€‚

```python title="extension.py"
@override  
async def finalize(self) -> None:
    """å¿«é€Ÿè§¦å‘æœ€ç»ˆç»“æœ
    
    æ”¶åˆ°VADæ£€æµ‹åˆ°äººå£°ç»“æŸåï¼Œç«‹å³è§¦å‘ASRæœåŠ¡è¿”å›finalç»“æœã€‚
    è¿™å¯¹äºå¯¹è¯åœºæ™¯éå¸¸é‡è¦ï¼Œå¯ä»¥æ˜¾è‘—é™ä½ç”¨æˆ·æ„ŸçŸ¥çš„å»¶è¿Ÿã€‚
    
    å®ç°æ–¹å¼ï¼š
    - Deepgram: è°ƒç”¨finalize() APIå¿«é€Ÿç»“æŸè½¬å½•
    - å…¶ä»–æœåŠ¡å•†: å¯é€šè¿‡æ–­è¿ã€å‘é€é™éŸ³åŒ…ç­‰æ–¹å¼å®ç°
    """
    if self.deepgram_client:
        # è®°å½•finalizeæ—¶é—´æˆ³ï¼Œç”¨äºå»¶è¿Ÿè®¡ç®—
        self.last_finalize_timestamp = asyncio.get_event_loop().time() * 1000
        await self.deepgram_client.finalize()
        await self.send_asr_finalize_end()
```

### å®ç°ä¾›åº”å•†äº‹ä»¶å¤„ç†

ASR æ‰©å±•éœ€è¦å¤„ç†ä¾›åº”å•†çš„å„ç§äº‹ä»¶ï¼ŒåŒ…æ‹¬è¿æ¥çŠ¶æ€å˜åŒ–ã€è¯†åˆ«ç»“æœå’Œé”™è¯¯æƒ…å†µã€‚è¿™æ˜¯å®ç°ç¨³å®š ASR æœåŠ¡çš„å…³é”®éƒ¨åˆ†ã€‚

#### äº‹ä»¶æ³¨å†Œ

é¦–å…ˆæ³¨å†Œæ‰€æœ‰å¿…è¦çš„äº‹ä»¶å¤„ç†å™¨ï¼š

```python title="extension.py"
async def _register_deepgram_events(self) -> None:
    """æ³¨å†ŒDeepgram WebSocketäº‹ä»¶å¤„ç†å™¨"""
    if not self.deepgram_client:
        return
        
    self.deepgram_client.on(LiveTranscriptionEvents.Open, self._on_open)
    self.deepgram_client.on(LiveTranscriptionEvents.Close, self._on_close)
    self.deepgram_client.on(LiveTranscriptionEvents.Transcript, self._on_transcript)
    self.deepgram_client.on(LiveTranscriptionEvents.Error, self._on_error)
```

#### è¿æ¥çŠ¶æ€ç®¡ç†

**å…³é”®è¦ç‚¹**ï¼šè¿æ¥çŠ¶æ€å˜åŒ–å¿…é¡»æ‰“å°å…³é”®æ—¥å¿—ï¼Œå¸®åŠ©æ’æŸ¥è¿æ¥é—®é¢˜ã€‚

```python title="extension.py"
async def _on_open(self, *args, **kwargs) -> None:
    """è¿æ¥å»ºç«‹æˆåŠŸå›è°ƒ"""
    self.is_connected_flag = True
    
    # æ‰“å°å…³é”®è¿æ¥æ—¥å¿—
    self.ten_env.log_info(
        "vendor_status_changed: connection opened",
        category=LOG_CATEGORY_VENDOR
    )
    
    # é‡ç½®é‡è¿è®¡æ•°å™¨
    if self.reconnect_manager:
        self.reconnect_manager.mark_connection_successful()

async def _on_close(self, *args, **kwargs) -> None:
    """è¿æ¥å…³é—­å›è°ƒ"""
    self.is_connected_flag = False
    
    # æ‰“å°å…³é”®æ–­è¿æ—¥å¿—
    self.ten_env.log_warn(
        "vendor_status_changed: connection closed",
        category=LOG_CATEGORY_VENDOR
    )
    
    # æ£€æŸ¥æ˜¯å¦ä¸ºæ„å¤–æ–­è¿
    if self.deepgram_client:  # å®¢æˆ·ç«¯å­˜åœ¨è¯´æ˜éä¸»åŠ¨å…³é—­
        self.ten_env.log_warn(
            "Unexpected disconnection detected, attempting reconnection",
            category=LOG_CATEGORY_VENDOR
        )
        # è§¦å‘è‡ªåŠ¨é‡è¿
        await self._handle_reconnect()
```

#### è¯†åˆ«ç»“æœå¤„ç†

**å…³é”®è¦ç‚¹**ï¼šæ”¶åˆ°ä¾›åº”å•†ç»“æœåå¿…é¡»è½¬æ¢æˆæ ‡å‡† ASRResult ç»“æ„å¹¶é€šè¿‡ `send_asr_result` å‘é€ã€‚

```python title="extension.py"
async def _on_transcript(self, *args, **kwargs) -> None:
    """å¤„ç†è½¬å½•ç»“æœå›è°ƒ"""
    result = args[1] if len(args) > 1 else None
    if not result:
        return
    
    # æ‰“å°ä¾›åº”å•†åŸå§‹ç»“æœï¼ˆè°ƒè¯•ç”¨ï¼‰
    self.ten_env.log_debug(
        f"vendor_result: received transcript: {result}",
        category=LOG_CATEGORY_VENDOR
    )
        
    try:
        # è§£æDeepgramç»“æœæ ¼å¼
        transcript_data = result.channel.alternatives[0] if result.channel.alternatives else None
        if not transcript_data or not transcript_data.transcript:
            return
        
        transcript_text = transcript_data.transcript.strip()
        if not transcript_text:
            return
            
        # è½¬æ¢ä¸ºæ ‡å‡†ASRç»“æœç»“æ„
        asr_result = ASRResult(
            text=transcript_text,
            final=result.is_final,
            start_ms=int(result.start * 1000) if hasattr(result, 'start') else 0,
            duration_ms=int(result.duration * 1000) if hasattr(result, 'duration') else 0,
            language=self.config.params.get("language", "en") or "en"
        )
        
        # æ‰“å°å¤„ç†åçš„ç»“æœ
        self.ten_env.log_debug(
            f"processed transcript: {transcript_text}, is_final: {result.is_final}",
            category=LOG_CATEGORY_VENDOR
        )
        
        # é€šè¿‡æ ‡å‡†æ¥å£å‘é€ç»“æœ
        await self.send_asr_result(asr_result)
        
    except Exception as e:
        # è®°å½•ç»“æœå¤„ç†é”™è¯¯
        self.ten_env.log_error(
            f"Error processing transcript: {type(e).__name__}: {e}",
            category=LOG_CATEGORY_VENDOR
        )
        # ä¸ŠæŠ¥éè‡´å‘½é”™è¯¯
        await self.send_asr_error(
            ModuleError(
                module=MODULE_NAME_ASR,
                code=ModuleErrorCode.NON_FATAL_ERROR.value,
                message=f"Failed to process transcript: {str(e)}",
            )
        )
```

#### é”™è¯¯å¤„ç†å’Œé‡è¿

**å…³é”®è¦ç‚¹**ï¼šä¾›åº”å•†é”™è¯¯å¿…é¡»æ‰“å°æ—¥å¿—ã€ä¸ŠæŠ¥é”™è¯¯å¹¶è§¦å‘è‡ªåŠ¨é‡è¿ã€‚

```python title="extension.py"
async def _on_error(self, *args, **kwargs) -> None:
    """ä¾›åº”å•†é”™è¯¯å›è°ƒ"""
    error = args[1] if len(args) > 1 else None
    if not error:
        return
    
    # æ‰“å°å…³é”®é”™è¯¯æ—¥å¿—
    self.ten_env.log_error(
        f"vendor_error: deepgram error: {error}",
        category=LOG_CATEGORY_VENDOR
    )
    
    # ä¸ŠæŠ¥é”™è¯¯ä¿¡æ¯ï¼ˆåŒ…å«ä¾›åº”å•†è¯¦ç»†ä¿¡æ¯ï¼‰
    await self.send_asr_error(
        ModuleError(
            module=MODULE_NAME_ASR,
            code=ModuleErrorCode.NON_FATAL_ERROR.value,
            message=f"Vendor error: {str(error)}",
        ),
        ModuleErrorVendorInfo(
            vendor="deepgram",
            code=getattr(error, 'code', 'unknown'),
            message=str(error),
        )
    )
    
    # è§¦å‘è‡ªåŠ¨é‡è¿ï¼ˆè¯¦ç»†å®ç°è§"é«˜çº§åŠŸèƒ½å®ç°"ç« èŠ‚ï¼‰
    await self._handle_reconnect()
```

<Callout type="info">
  é‡è¿æœºåˆ¶çš„å®Œæ•´å®ç°è¯·å‚è€ƒåç»­çš„ [é‡è¿æœºåˆ¶](#é‡è¿æœºåˆ¶) ç« èŠ‚ï¼Œå…¶ä¸­ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ `ReconnectManager` å®ç°æ™ºèƒ½é‡è¿ã€‚
</Callout>

## 5. ğŸš€ é«˜çº§åŠŸèƒ½å®ç°

### é‡è¿æœºåˆ¶

å½“ ASR æœåŠ¡å‡ºç°è¿æ¥é”™è¯¯æˆ–æ„å¤–æ–­è¿æ—¶ï¼Œéœ€è¦æœ‰å¥å£®çš„é‡è¿æœºåˆ¶æ¥ä¿è¯æœåŠ¡çš„ç¨³å®šæ€§ã€‚æ¨èä½¿ç”¨ `ReconnectManager` æ¥å®ç°æ™ºèƒ½é‡è¿ã€‚

<Callout type="tip">
  `ReconnectManager` çš„å®Œæ•´å®ç°å¯å‚è€ƒ `azure_asr_python` æˆ– `deepgram_asr_python` æ‰©å±•ä¸­çš„ `reconnect_manager.py` æ–‡ä»¶ã€‚
</Callout>

#### ä½¿ç”¨ ReconnectManager

**1. åˆå§‹åŒ– ReconnectManager**

åœ¨æ‰©å±•çš„æ„é€ å‡½æ•°ä¸­åˆ›å»º ReconnectManager å®ä¾‹ï¼š

```python title="extension.py"
from .reconnect_manager import ReconnectManager

class MyAsrExtension(AsyncASRBaseExtension):
    def __init__(self, name: str):
        super().__init__(name)
        self.config: MyAsrConfig = MyAsrConfig()
        self.deepgram_client: Optional[AsyncListenWebSocketClient] = None
        self.is_connected_flag: bool = False
        
        # åˆå§‹åŒ–é‡è¿ç®¡ç†å™¨ï¼šæœ€å¤šé‡è¿5æ¬¡ï¼ŒåŸºç¡€å»¶è¿Ÿ0.5ç§’
        self.reconnect_manager = ReconnectManager(max_attempts=5, base_delay=0.5)
```

**2. è¿æ¥æˆåŠŸæ—¶é‡ç½®è®¡æ•°å™¨**

åœ¨è¿æ¥æˆåŠŸçš„å›è°ƒä¸­é‡ç½®é‡è¿è®¡æ•°å™¨ï¼š

```python title="extension.py"
async def _on_open(self, *args, **kwargs) -> None:
    """è¿æ¥å»ºç«‹æˆåŠŸå›è°ƒ"""
    self.is_connected_flag = True
    
    self.ten_env.log_info(
        "vendor_status_changed: connection opened",
        category=LOG_CATEGORY_VENDOR
    )
    
    # è¿æ¥æˆåŠŸï¼Œé‡ç½®é‡è¿è®¡æ•°å™¨
    if self.reconnect_manager:
        self.reconnect_manager.mark_connection_successful()
```

**3. å®ç°é‡è¿å¤„ç†é€»è¾‘**

å½“å‘ç”Ÿé”™è¯¯æˆ–æ–­è¿æ—¶ï¼Œè°ƒç”¨é‡è¿å¤„ç†ï¼š

```python title="extension.py"
async def _handle_reconnect(self) -> None:
    """å¤„ç†é‡è¿é€»è¾‘"""
    if not self.reconnect_manager:
        self.ten_env.log_warn(
            "No reconnect manager available, skipping reconnection",
            category=LOG_CATEGORY_VENDOR
        )
        return
        
    try:
        # æ£€æŸ¥æ˜¯å¦å¯ä»¥é‡è¯•
        if not self.reconnect_manager.can_retry():
            self.ten_env.log_error(
                f"Maximum reconnection attempts ({self.reconnect_manager.max_attempts}) reached",
                category=LOG_CATEGORY_VENDOR
            )
            # è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œå‘é€è‡´å‘½é”™è¯¯
            await self.send_asr_error(
                ModuleError(
                    module=MODULE_NAME_ASR,
                    code=ModuleErrorCode.FATAL_ERROR.value,
                    message="Reconnection failed permanently",
                )
            )
            return
        
        # ä½¿ç”¨é‡è¿ç®¡ç†å™¨å¤„ç†é‡è¿
        self.ten_env.log_info(
            f"Attempting reconnection, attempts: {self.reconnect_manager.current_attempts + 1}/{self.reconnect_manager.max_attempts}",
            category=LOG_CATEGORY_VENDOR
        )
        
        # è°ƒç”¨ ReconnectManager çš„ handle_reconnect æ–¹æ³•
        success = await self.reconnect_manager.handle_reconnect(
            connect_func=self.start_connection
        )
        
        if success:
            self.ten_env.log_info(
                "Reconnection successful",
                category=LOG_CATEGORY_VENDOR
            )
        else:
            self.ten_env.log_error(
                "Reconnection failed",
                category=LOG_CATEGORY_VENDOR
            )
            
    except Exception as e:
        self.ten_env.log_error(
            f"Error in reconnection handler: {e}",
            category=LOG_CATEGORY_VENDOR
        )
```

**4. åœ¨é”™è¯¯å’Œæ–­è¿æ—¶è§¦å‘é‡è¿**

```python title="extension.py"
async def _on_close(self, *args, **kwargs) -> None:
    """è¿æ¥å…³é—­å›è°ƒ"""
    self.is_connected_flag = False
    
    self.ten_env.log_warn(
        "vendor_status_changed: connection closed",
        category=LOG_CATEGORY_VENDOR
    )
    
    # æ£€æŸ¥æ˜¯å¦ä¸ºæ„å¤–æ–­è¿ï¼ˆå®¢æˆ·ç«¯å­˜åœ¨è¯´æ˜éä¸»åŠ¨å…³é—­ï¼‰
    if self.deepgram_client:
        self.ten_env.log_warn(
            "Unexpected disconnection detected, attempting reconnection",
            category=LOG_CATEGORY_VENDOR
        )
        # è§¦å‘é‡è¿
        await self._handle_reconnect()

async def _on_error(self, *args, **kwargs) -> None:
    """ä¾›åº”å•†é”™è¯¯å›è°ƒ"""
    error = args[1] if len(args) > 1 else None
    if not error:
        return
    
    self.ten_env.log_error(
        f"vendor_error: {error}",
        category=LOG_CATEGORY_VENDOR
    )
    
    await self.send_asr_error(
        ModuleError(
            module=MODULE_NAME_ASR,
            code=ModuleErrorCode.NON_FATAL_ERROR.value,
            message=f"Vendor error: {str(error)}",
        ),
        ModuleErrorVendorInfo(
            vendor="deepgram",
            code=getattr(error, 'code', 'unknown'),
            message=str(error),
        )
    )
    
    # è§¦å‘é‡è¿
    await self._handle_reconnect()
```

#### ReconnectManager å…³é”®ç‰¹æ€§

- **æŒ‡æ•°é€€é¿**ï¼šæ¯æ¬¡é‡è¿çš„å»¶è¿Ÿæ—¶é—´æŒ‰æŒ‡æ•°å¢é•¿ï¼ˆ0.5s â†’ 1s â†’ 2s â†’ 4s â†’ 8sï¼‰ï¼Œé¿å…è¿‡äºé¢‘ç¹çš„é‡è¿
- **æ¬¡æ•°é™åˆ¶**ï¼šè®¾ç½®æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œé¿å…æ— é™é‡è¿
- **çŠ¶æ€ç®¡ç†**ï¼šè¿æ¥æˆåŠŸåè‡ªåŠ¨é‡ç½®è®¡æ•°å™¨ï¼Œä¸ºä¸‹æ¬¡å¯èƒ½çš„æ–­è¿åšå¥½å‡†å¤‡
- **é”™è¯¯åŒºåˆ†**ï¼šè¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°åä¸ŠæŠ¥è‡´å‘½é”™è¯¯ï¼ˆFATAL_ERRORï¼‰ï¼Œå…¶ä»–æƒ…å†µä¸ŠæŠ¥éè‡´å‘½é”™è¯¯ï¼ˆNON_FATAL_ERRORï¼‰

### éŸ³é¢‘è°ƒè¯•åŠŸèƒ½

é›†æˆéŸ³é¢‘ Dump åŠŸèƒ½ï¼š

```python title="extension.py"
import os
from ten_ai_base.dumper import Dumper

# åœ¨æ–‡ä»¶é¡¶éƒ¨å®šä¹‰å¸¸é‡
DUMP_FILE_NAME = "my_asr_in.pcm"

class MyAsrExtension(AsyncASRBaseExtension):        
    @override
    async def on_init(self, ten_env: AsyncTenEnv) -> None:
        """åˆå§‹åŒ–é˜¶æ®µé…ç½®"""
        await super().on_init(ten_env)
        
        # åˆå§‹åŒ–éŸ³é¢‘dumper
        if self.config.dump:
            dump_file_path = os.path.join(
                self.config.dump_path, DUMP_FILE_NAME
            )
            self.audio_dumper = Dumper(dump_file_path)
            await self.audio_dumper.start()
            
    @override
    async def on_deinit(self, ten_env: AsyncTenEnv) -> None:
        """æ¸…ç†èµ„æº"""
        await super().on_deinit(ten_env)
        if self.audio_dumper:
            await self.audio_dumper.stop()
            self.audio_dumper = None
        
    @override
    async def send_audio(self, audio_frame: AudioFrame) -> bool:
        """å‘é€éŸ³é¢‘æ•°æ®ï¼ˆå«è°ƒè¯•åŠŸèƒ½ï¼‰"""
        buf = audio_frame.get_buf()
        if self.audio_dumper:
            await self.audio_dumper.push_bytes(bytes(buf))
        ...
```

## 6. ğŸ§ª å•å…ƒæµ‹è¯•

### åˆ›å»ºæµ‹è¯•æ¡†æ¶

#### Mockçš„å¿…è¦æ€§

åœ¨å•å…ƒæµ‹è¯•ä¸­ä½¿ç”¨Mockè€ŒéçœŸå®APIè°ƒç”¨çš„åŸå› ï¼š

- **ğŸ”„ CI/CDå‹å¥½**: æ¯æ¬¡CIéƒ½ä¼šè§¦å‘æ‰§è¡Œï¼Œé¿å…ä¾›åº”å•†é…é¢æ¶ˆè€—
- **ğŸ’° æˆæœ¬æ§åˆ¶**: é¿å…ä¸å¿…è¦çš„APIè°ƒç”¨è´¹ç”¨
- **ğŸ›¡ï¸ ç¨³å®šæ€§**: é¿å…å› ä¾›åº”å•†è¿æ¥ä¸ç¨³å®šå¯¼è‡´çš„CIå¤±è´¥
- **âš¡ æ‰§è¡Œé€Ÿåº¦**: Mockå“åº”æ›´å¿«ï¼Œæå‡æµ‹è¯•æ‰§è¡Œæ•ˆç‡
- **ğŸ§ª å¯æ§æ€§**: å¯ä»¥æ¨¡æ‹Ÿå„ç§è¾¹ç•Œæƒ…å†µå’Œé”™è¯¯åœºæ™¯

#### æœ€ä½³å®è·µå»ºè®®

- **å¼€å‘è°ƒè¯•é˜¶æ®µ**: å¯ä»¥ä½¿ç”¨çœŸå®çš„API Keyè¿›è¡Œæµ‹è¯•ï¼ŒéªŒè¯å®é™…é›†æˆæ•ˆæœ
- **æ­£å¼æäº¤å‰**: åˆ‡æ¢åˆ°Mockå®ç°ï¼Œç¡®ä¿CI/CDç¯å¢ƒçš„ç¨³å®šè¿è¡Œ
- **è¾¹ç•Œæµ‹è¯•**: ä½¿ç”¨Mockæ¨¡æ‹Ÿç½‘ç»œè¶…æ—¶ã€æœåŠ¡é”™è¯¯ç­‰å¼‚å¸¸æƒ…å†µ

åœ¨ `tests/mock.py` ä¸­åˆ›å»º Mock å¯¹è±¡ï¼š

```python title="tests/mock.py"
import pytest
from unittest.mock import MagicMock, patch
from types import SimpleNamespace

@pytest.fixture(scope="function")
def patch_deepgram_ws():
    """Mock Deepgram WebSocketå®¢æˆ·ç«¯"""
    with patch("ten_packages.extension.my_asr_extension.extension.AsyncListenWebSocketClient") as mock_client:
        # åˆ›å»ºmockå®ä¾‹
        mock_instance = MagicMock()
        mock_client.return_value = mock_instance
        
        # å­˜å‚¨äº‹ä»¶å¤„ç†å™¨
        event_handlers = {}
        
        def mock_on(event, handler):
            event_handlers[event] = handler
            
        mock_instance.on = mock_on
        mock_instance.start = MagicMock()
        mock_instance.send = MagicMock()
        mock_instance.finish = MagicMock()
        mock_instance.finalize = MagicMock()
        
        # æä¾›è§¦å‘äº‹ä»¶çš„æ–¹æ³•
        def trigger_open():
            if 'open' in event_handlers:
                event_handlers['open']()
                
        def trigger_transcript(text, is_final=False):
            if 'transcript' in event_handlers:
                # æ¨¡æ‹ŸDeepgramå“åº”æ ¼å¼
                mock_result = SimpleNamespace()
                mock_result.channel = SimpleNamespace()
                mock_result.channel.alternatives = [SimpleNamespace()]
                mock_result.channel.alternatives[0].transcript = text
                mock_result.is_final = is_final
                mock_result.start = 0.0
                mock_result.duration = 1.0
                
                event_handlers['transcript'](None, mock_result)
                
        mock_instance.trigger_open = trigger_open
        mock_instance.trigger_transcript = trigger_transcript
        
        yield mock_instance
```

### æµ‹è¯•ç”¨ä¾‹è®¾è®¡

#### æµ‹è¯•è¦†ç›–èŒƒå›´

å•å…ƒæµ‹è¯•åº”è¯¥è¦†ç›–ä»¥ä¸‹æ ¸å¿ƒåœºæ™¯ï¼Œç¡®ä¿ ASR æ‰©å±•çš„ç¨³å®šæ€§å’Œæ­£ç¡®æ€§ï¼š

##### 1. é…ç½®ç®¡ç†æµ‹è¯•
- **âœ… æœ‰æ•ˆé…ç½®**: æ­£ç¡®è§£æå’Œåˆå§‹åŒ–é…ç½®å‚æ•°
- **âŒ é”™è¯¯é…ç½®**: ä½¿ç”¨æ— æ•ˆé…ç½®æ—¶èƒ½ä¸ŠæŠ¥é”™è¯¯å¹¶é™çº§å¤„ç†
- **ğŸ” æ•æ„Ÿä¿¡æ¯è„±æ•**: éªŒè¯æ—¥å¿—è¾“å‡ºä¸­æ•æ„Ÿä¿¡æ¯è¢«æ­£ç¡®åŠ å¯†

##### 2. éŸ³é¢‘å¤„ç†æµ‹è¯•
- **ğŸµ éŸ³é¢‘å‘é€**: è¾“å…¥éŸ³é¢‘å¸§åèƒ½æ­£ç¡®å‘é€ç»™ä¾›åº”å•†
- **ğŸ“Š ç»“æœæ¥æ”¶**: æ”¶åˆ°ä¾›åº”å•†ç»“æœåèƒ½è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼å¹¶å‘é€
- **â±ï¸ æ—¶é—´æˆ³è®¡ç®—**: éªŒè¯ ASR ç»“æœä¸­çš„æ—¶é—´ä¿¡æ¯å‡†ç¡®æ€§

##### 3. è¿æ¥ç®¡ç†æµ‹è¯•
- **ğŸ”— æ­£å¸¸è¿æ¥**: éªŒè¯è¿æ¥å»ºç«‹å’ŒçŠ¶æ€ç®¡ç†
- **ğŸ”„ è‡ªåŠ¨é‡è¿**: è¿æ¥é”™è¯¯æ—¶èƒ½è‡ªåŠ¨é‡è¿
- **ğŸ“‹ çŠ¶æ€æ—¥å¿—**: è¿æ¥çŠ¶æ€å˜åŒ–èƒ½æ‰“å°å…³é”®æ—¥å¿—

##### 4. Finalize æµç¨‹æµ‹è¯•
- **ğŸ“¥ æ¥æ”¶å¤„ç†**: èƒ½æ­£ç¡®å¤„ç† `asr_finalize` æ•°æ®
- **âš¡ å¿«é€Ÿå“åº”**: è°ƒç”¨ä¾›åº”å•† finalize API
- **ğŸ“¤ å®Œæˆé€šçŸ¥**: å¤„ç†å®Œæˆåå‘é€ `asr_finalize_end` æ•°æ®

##### 5. é”™è¯¯å¤„ç†æµ‹è¯•
- **ğŸš¨ é”™è¯¯ä¸ŠæŠ¥**: å„ç±»é”™è¯¯èƒ½é€šè¿‡ `send_asr_error` æ­£ç¡®ä¸ŠæŠ¥
- **ğŸ” é”™è¯¯åˆ†ç±»**: åŒºåˆ†è‡´å‘½é”™è¯¯å’Œéè‡´å‘½é”™è¯¯
- **ğŸ“Š ä¾›åº”å•†ä¿¡æ¯**: ä¾›åº”å•†é”™è¯¯åŒ…å«è¯¦ç»†çš„ vendor_info

##### 6. éŸ³é¢‘è°ƒè¯•åŠŸèƒ½æµ‹è¯•
- **ğŸ’¾ éŸ³é¢‘å­˜å‚¨**: å¼€å¯ dump åèƒ½ç”Ÿæˆæ­£ç¡®çš„éŸ³é¢‘æ–‡ä»¶
- **ğŸ“ è·¯å¾„ç®¡ç†**: éªŒè¯ dump æ–‡ä»¶è·¯å¾„å’Œå‘½å
- **ğŸ›ï¸ å¼€å…³æ§åˆ¶**: dump åŠŸèƒ½çš„å¯ç”¨å’Œç¦ç”¨

##### 7. æ€§èƒ½æŒ‡æ ‡æµ‹è¯•
- **â±ï¸ TTFW æŒ‡æ ‡**: éªŒè¯é¦–è¯å»¶è¿Ÿè®¡ç®—
- **â±ï¸ TTLW æŒ‡æ ‡**: éªŒè¯æœ«è¯å»¶è¿Ÿè®¡ç®—
- **ğŸ“Š è‡ªå®šä¹‰æŒ‡æ ‡**: ä¾›åº”å•†ç‰¹å®šæŒ‡æ ‡ä¸ŠæŠ¥

### ç¼–å†™æµ‹è¯•ç”¨ä¾‹

å…·ä½“çš„æµ‹è¯•ç”¨ä¾‹å®ç°å¯ä»¥å‚è€ƒ `azure_asr_python` æ‰©å±•ä¸­çš„æµ‹è¯•è®¾è®¡

### è¿è¡Œå•å…ƒæµ‹è¯•

```bash title="Terminal"
cd my_asr_extension
./tests/bin/start
```

### æ–­ç‚¹è°ƒè¯•

æ¨¡æ¿åˆ›å»ºçš„æ‰©å±•é¡¹ç›®åŒ…å« `.vscode` ç›®å½•ï¼Œæä¾›äº†å¼€ç®±å³ç”¨çš„è°ƒè¯•é…ç½®ã€‚

#### ä½¿ç”¨ VS Code è°ƒè¯•

1. **æ‰“å¼€é¡¹ç›®**: åœ¨ VS Code ä¸­æ‰“å¼€ `my_asr_extension` ç›®å½•

2. **æŸ¥çœ‹è°ƒè¯•é…ç½®**: `.vscode/launch.json` ä¸­é¢„ç½®äº†è°ƒè¯•è„šæœ¬

```json title=".vscode/launch.json"
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Python: Test Extension",
            "type": "python",
            "request": "launch",
            "program": "${workspaceFolder}/tests/bin/start",
            "args": [],
            "console": "integratedTerminal",
            "cwd": "${workspaceFolder}",
            "env": {
                "PYTHONPATH": "${workspaceFolder}:${workspaceFolder}/.ten/app/ten_packages/system/ten_runtime_python/lib:${workspaceFolder}/.ten/app/ten_packages/system/ten_runtime_python/interface:${workspaceFolder}/.ten/app/ten_packages/system/ten_ai_base/interface"
            }
        }
    ]
}
```

3. **è®¾ç½®æ–­ç‚¹**: åœ¨ `extension.py` æˆ–æµ‹è¯•æ–‡ä»¶ä¸­è®¾ç½®æ–­ç‚¹

4. **å¯åŠ¨è°ƒè¯•**: 
   - æŒ‰ `F5` æˆ–ä½¿ç”¨è°ƒè¯•é¢æ¿
   - é€‰æ‹© "Python: Test Extension" é…ç½®
   - è°ƒè¯•å™¨ä¼šè‡ªåŠ¨è¿è¡Œæµ‹è¯•ç”¨ä¾‹

#### è°ƒè¯•ç‰¹å®šæµ‹è¯•

ä¿®æ”¹ `launch.json` ä¸­çš„ `args` å‚æ•°æ¥è°ƒè¯•ç‰¹å®šæµ‹è¯•ï¼š

```json title=".vscode/launch.json"
{
    "args": [
        "tests/test_basic.py::test_asr_basic_functionality",  // è°ƒè¯•ç‰¹å®šæµ‹è¯•å‡½æ•°
        "-v"  // è¯¦ç»†è¾“å‡º
    ]
}
```

#### ç¯å¢ƒå˜é‡è°ƒè¯•

å¦‚æœéœ€è¦ä½¿ç”¨çœŸå®APIå¯†é’¥è°ƒè¯•ï¼Œå¯ä»¥åœ¨ `launch.json` ä¸­æ·»åŠ ç¯å¢ƒå˜é‡ï¼š

```json title=".vscode/launch.json"
{
    "env": {
        "PYTHONPATH": "...",
        "DEEPGRAM_API_KEY": "your_real_api_key_here"
    }
}
```

## 7. ğŸ”— é›†æˆæµ‹è¯•ï¼ˆGuarderï¼‰

### ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º `.env` æ–‡ä»¶é…ç½®çœŸå® API å¯†é’¥ï¼š

```bash title=".env"
# Deepgram ASR API Key
DEEPGRAM_API_KEY=your_real_deepgram_api_key_here
```

### æµ‹è¯•é…ç½®

åœ¨ `tests/configs/` ä¸‹åˆ›å»ºæµ‹è¯•é…ç½®ï¼š

```json title="tests/configs/property_en.json"
{
  "params": {
    "api_key": "${env:DEEPGRAM_API_KEY}",
    "language": "en-US"
  }
}
```

### è¿è¡Œ Guarder æµ‹è¯•

ä½¿ç”¨çœŸå® API å¯†é’¥è¿è¡Œå®Œæ•´é›†æˆæµ‹è¯•ï¼š

```bash title="Terminal"
cd ai_agents
task asr-guarder-test EXTENSION=my_asr_extension
```

è¿™å°†è¿è¡ŒåŒ…æ‹¬ä»¥ä¸‹æµ‹è¯•ï¼š

- **ASR ç»“æœæµ‹è¯•**: éªŒè¯è¯†åˆ«å‡†ç¡®æ€§å’Œç»“æœæ ¼å¼
- **Finalize æµ‹è¯•**: éªŒè¯ VADæ£€æµ‹åˆ°äººå£°ç»“æŸåï¼Œä¿¡å·å¤„ç†å’Œå»¶è¿Ÿä¼˜åŒ–æ•ˆæœ
- **éŸ³é¢‘å¤„ç†æµ‹è¯•**: æµ‹è¯•å®æ—¶éŸ³é¢‘æµå¤„ç†
- **é”™è¯¯å¤„ç†æµ‹è¯•**: éªŒè¯ç½‘ç»œå¼‚å¸¸å’Œ API é”™è¯¯å¤„ç†
- **æ€§èƒ½æµ‹è¯•**: æµ‹é‡ TTFW(Time To First Word) å’Œ TTLW(Time To Last Word) æŒ‡æ ‡
- **å¤šè¯­è¨€æµ‹è¯•**: éªŒè¯ä¸åŒè¯­è¨€çš„è¯†åˆ«èƒ½åŠ›(è‹±æ–‡å’Œä¸­æ–‡)

#### å…³é”®æ€§èƒ½æŒ‡æ ‡

Guarder æµ‹è¯•ä¼šé‡ç‚¹éªŒè¯ä»¥ä¸‹å¯¹è¯åœºæ™¯çš„å…³é”®æŒ‡æ ‡ï¼š

- **TTFW**: é¦–æ¬¡è¯†åˆ«ç»“æœå»¶è¿Ÿï¼ˆé€šå¸¸ < 1000msï¼‰
- **TTLW**: Finalize åˆ°æœ€ç»ˆç»“æœå»¶è¿Ÿï¼ˆé€šå¸¸ < 300msï¼‰
- **è¯†åˆ«å‡†ç¡®ç‡**: åœ¨ä¸åŒéŸ³è´¨æ¡ä»¶ä¸‹çš„å‡†ç¡®æ€§
- **è¿æ¥ç¨³å®šæ€§**: é•¿æ—¶é—´ä¼šè¯çš„è¿æ¥ä¿æŒèƒ½åŠ›

## 8. ğŸŒ ç«¯åˆ°ç«¯æµ‹è¯•

å®Œæˆå¼€å‘åï¼Œå¯ä»¥ä½¿ç”¨ TMan Designer å¿«é€Ÿæ›¿æ¢ TEN Agent å¯¹è¯å›¾ä¸­çš„ ASR æ‰©å±•ï¼ŒéªŒè¯åœ¨å®é™…å¯¹è¯åœºæ™¯ä¸‹çš„æ•ˆæœã€‚

### ä½¿ç”¨ TMan Designer æ›¿æ¢ ASR æ‰©å±•

```bash title="Terminal"
# åœ¨ TEN Agent é¡¹ç›®ç›®å½•ä¸‹å¯åŠ¨
cd /path/to/your/ten-agent-project
tman designer
```

TMan Designer ä¼šæ‰“å¼€å¯è§†åŒ–ç•Œé¢ï¼Œä½ å¯ä»¥ï¼š

1. **é€‰æ‹© ASR èŠ‚ç‚¹**: ç‚¹å‡»ç°æœ‰çš„ ASR æ‰©å±•ç§¯æœ¨
2. **æ›¿æ¢ä¸ºä½ çš„æ‰©å±•**: é€‰æ‹© `my_asr_extension`
3. **é…ç½®å‚æ•°**: è®¾ç½® API Keyã€è¯­è¨€ç­‰å‚æ•°
4. **ä¸€é”®åº”ç”¨**: å®Œæˆæ›¿æ¢å¹¶å¯åŠ¨æµ‹è¯•

æ›¿æ¢å®Œæˆåï¼Œé€šè¿‡çœŸå®å¯¹è¯éªŒè¯æ‰©å±•çš„è¯†åˆ«å‡†ç¡®æ€§ã€å“åº”é€Ÿåº¦å’Œç¨³å®šæ€§ã€‚

## 9. ğŸ“Š æœ€ä½³å®è·µ

### é…ç½®ç®¡ç†

- âœ… ä½¿ç”¨ `params` å­—å…¸ç»Ÿä¸€ç®¡ç†ä¾›åº”å•†å‚æ•°
- âœ… é€šè¿‡ `@property` æ–¹æ³•æä¾›ç±»å‹å®‰å…¨çš„å‚æ•°è®¿é—®
- âœ… æä¾›åˆç†çš„é»˜è®¤å€¼

### é”™è¯¯å¤„ç†

- âœ… å®ç°æŒ‡æ•°é€€é¿é‡è¿æœºåˆ¶
- âœ… æ­£ç¡®å¤„ç†ç½‘ç»œå¼‚å¸¸å’Œ API é”™è¯¯
- âœ… æä¾›è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’ŒçŠ¶æ€ä¸ŠæŠ¥
- âœ… ä¼˜é›…å¤„ç†è¿æ¥ä¸­æ–­å’Œæ¢å¤

### æ€§èƒ½ä¼˜åŒ–

- âœ… å¼‚æ­¥å¤„ç†éŸ³é¢‘æµï¼Œé¿å…é˜»å¡
- âœ… å®ç°éŸ³é¢‘ç¼“å­˜å’Œæ‰¹é‡å‘é€
- âœ… åˆç†ç®¡ç† WebSocket è¿æ¥ç”Ÿå‘½å‘¨æœŸ
- âœ… ç›‘æ§å’ŒæŠ¥å‘Šå…³é”®æ€§èƒ½æŒ‡æ ‡

### æ—¥å¿—æ‰“å°

- âœ… ä½¿ç”¨ `ten_env.log_debug/info/warn/error` API æ‰“å°æ—¥å¿—
- âœ… é€šè¿‡æŒ‡å®š `category` è®©æ—¥å¿—æ›´åŠ æ¸…æ™°
- âœ… å¯¹æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚ API Keyï¼‰è¿›è¡Œè„±æ•å¤„ç†
- âœ… åœ¨å…³é”®èŠ‚ç‚¹è®°å½•çŠ¶æ€å˜åŒ–å’Œé”™è¯¯ä¿¡æ¯

#### æ—¥å¿—åˆ†ç±»è¯´æ˜

- **KEY_POINT**: å…³é”®èŠ‚ç‚¹æ—¥å¿—ï¼Œç”¨äºè®°å½•é‡è¦çš„é…ç½®å’ŒçŠ¶æ€ä¿¡æ¯
- **VENDOR**: ä¾›åº”å•†ç›¸å…³æ—¥å¿—ï¼ŒåŒ…æ‹¬è¿æ¥çŠ¶æ€ã€ç»“æœå¤„ç†ã€é”™è¯¯ä¿¡æ¯
- **é»˜è®¤åˆ†ç±»**: ä¸šåŠ¡é€»è¾‘ç›¸å…³çš„ä¸€èˆ¬æ—¥å¿—

### é”™è¯¯ä¸ŠæŠ¥

é™¤äº†æ—¥å¿—è®°å½•ï¼Œè¿˜éœ€è¦é€šè¿‡ `self.send_asr_error` API è¿›è¡Œç»“æ„åŒ–çš„é”™è¯¯ä¸ŠæŠ¥

#### é”™è¯¯åˆ†ç±»ç­–ç•¥

**ğŸ”¥ è‡´å‘½é”™è¯¯ (FATAL_ERROR)**
- é…ç½®è§£æå¤±è´¥
- æ— æ•ˆçš„APIå¯†é’¥
- æ— æ³•å»ºç«‹åˆå§‹è¿æ¥
- æ‰©å±•æ— æ³•ç»§ç»­å·¥ä½œçš„æƒ…å†µ

**âš ï¸ éè‡´å‘½é”™è¯¯ (NON_FATAL_ERROR)** 
- ä¸´æ—¶çš„ç½‘ç»œè¿æ¥é—®é¢˜
- ä¾›åº”å•†æœåŠ¡æš‚æ—¶ä¸å¯ç”¨
- éŸ³é¢‘å¤„ç†é”™è¯¯
- å¯é€šè¿‡é‡è¿æ¢å¤çš„é”™è¯¯

#### ä¾›åº”å•†ä¿¡æ¯ (VendorInfo)

å¯¹äºä¾›åº”å•†è¿”å›çš„é”™è¯¯ï¼Œåº”åŒ…å«è¯¦ç»†çš„ä¾›åº”å•†ä¿¡æ¯ï¼š

```python
ModuleErrorVendorInfo(
    vendor="deepgram",           # ä¾›åº”å•†åç§°
    code="400",                  # ä¾›åº”å•†é”™è¯¯ç 
    message="Invalid audio format", # ä¾›åº”å•†é”™è¯¯æ¶ˆæ¯
)
```

è¿™æ ·å¯ä»¥å¸®åŠ©è¿ç»´å›¢é˜Ÿå¿«é€Ÿå®šä½é—®é¢˜æ¥æºï¼ŒåŒºåˆ†æ˜¯æ‰©å±•é—®é¢˜è¿˜æ˜¯ä¾›åº”å•†æœåŠ¡é—®é¢˜ã€‚

#### æ•æ„Ÿä¿¡æ¯è„±æ•

```python title="config.py"
def to_json(self, sensitive_handling: bool = False) -> str:
    """åºåˆ—åŒ–é…ç½®ï¼Œæ”¯æŒæ•æ„Ÿä¿¡æ¯è„±æ•"""
    config_dict = self.model_dump()
    
    if sensitive_handling:
        # è„±æ•å¤„ç†æ•æ„Ÿå­—æ®µ
        if "api_key" in config_dict.get("params", {}):
            api_key = config_dict["params"]["api_key"]
            if len(api_key) > 6:
                config_dict["params"]["api_key"] = f"{api_key[:2]}...{api_key[-2:]}"
    
    return json.dumps(config_dict)
```

### è°ƒè¯•æ”¯æŒ

- âœ… æä¾›éŸ³é¢‘ Dump åŠŸèƒ½ç”¨äºé—®é¢˜æ’æŸ¥
- âœ… è®°å½•è¯¦ç»†çš„äº‹ä»¶å’ŒçŠ¶æ€å˜åŒ–æ—¥å¿—
- âœ… æ”¯æŒä¸åŒæ—¥å¿—çº§åˆ«å’Œåˆ†ç±»
- âœ… æä¾›æ€§èƒ½å’Œè´¨é‡æŒ‡æ ‡

## 10. ğŸŒŸ æ‰©å±•å’Œè´¡çŒ®

### é€‚é…å…¶ä»– ASR æœåŠ¡

åŸºäºæœ¬æ•™ç¨‹çš„æ¡†æ¶ï¼Œä½ å¯ä»¥å‚è€ƒ TEN Framework ä»“åº“ä¸‹çš„å…¶ä»–æˆå“ ASR æ‰©å±•ï¼š

1. **Azure Speech Services**: å‚è€ƒ `azure_asr_python` æ‰©å±•çš„å®ç°
2. **Google Cloud Speech**: å‚è€ƒ `google_asr_python` æ‰©å±•çš„å®ç°  
3. **ç§‘å¤§è®¯é£**: å‚è€ƒ `xfyun_asr_python` æ‰©å±•çš„å®ç°
4. **å…¶ä»–ä¾›åº”å•†**: åœ¨ `ai_agents/agents/ten_packages/extension/` ç›®å½•ä¸‹æŸ¥çœ‹æ›´å¤šASRæ‰©å±•å®ç°

è¿™äº›æˆå“æ‰©å±•éƒ½éµå¾ªç›¸åŒçš„æ¶æ„æ¨¡å¼ï¼Œå¯ä»¥ä½œä¸ºé€‚é…æ–°ASRæœåŠ¡çš„å‚è€ƒæ¨¡æ¿ï¼š

```bash title="å‚è€ƒæ‰©å±•ä½ç½®"
ten-framework/
â””â”€â”€ ai_agents/agents/ten_packages/extension/
    â”œâ”€â”€ azure_asr_python/          # Azure Speech Services
    â”œâ”€â”€ deepgram_asr_python/       # Deepgram ASR  
    â”œâ”€â”€ google_asr_python/         # Google Cloud Speech
    â”œâ”€â”€ xfyun_asr_python/          # ç§‘å¤§è®¯é£è¯­éŸ³
    â””â”€â”€ ...                        # æ›´å¤šASRæ‰©å±•
```

### è´¡çŒ®åˆ°ç¤¾åŒº

å®Œæˆå¼€å‘åï¼Œæ¬¢è¿å°†ä½ çš„ ASR æ‰©å±•è´¡çŒ®ç»™ TEN Agent ç¤¾åŒºï¼š

1. **ä»£ç è§„èŒƒ**: éµå¾ªé¡¹ç›®çš„ä»£ç é£æ ¼å’Œå‘½åçº¦å®š
2. **æµ‹è¯•è¦†ç›–**: ç¡®ä¿å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•é€šè¿‡
3. **æ–‡æ¡£å®Œå–„**: æä¾›æ¸…æ™°çš„ README å’Œé…ç½®è¯´æ˜
4. **æ€§èƒ½éªŒè¯**: é€šè¿‡ Guarder æµ‹è¯•éªŒè¯ç”Ÿäº§å¯ç”¨æ€§

### å‘å¸ƒåˆ° TEN Store

è®©ä½ çš„ ASR æ‰©å±•è¢«æ›´å¤šå¼€å‘è€…ä½¿ç”¨ï¼š

#### 1. æäº¤åˆ°ä¸»ä»“åº“

```bash title="Terminal"
# 1. Fork TEN Framework ä»“åº“åˆ°ä½ çš„ GitHub è´¦å·
# 2. å…‹éš†ä½ çš„ fork ä»“åº“
git clone https://github.com/your-username/ten-framework.git
cd ten-framework

# 3. å°†ä½ çš„æ‰©å±•å¤åˆ¶åˆ°æ­£ç¡®ä½ç½®
cp -r /path/to/your/my_asr_extension ai_agents/agents/ten_packages/extension/

# 4. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
git checkout -b feat/add-my-asr-extension

# 5. æäº¤æ›´æ”¹
git add ai_agents/agents/ten_packages/extension/my_asr_extension/
git commit -m "feat: add my_asr_extension for [ä¾›åº”å•†åç§°] ASR service"

# 6. æ¨é€åˆ†æ”¯
git push origin feat/add-my-asr-extension
```

#### 2. åˆ›å»º Pull Request

1. **æ‰“å¼€ GitHub**: è®¿é—®ä½ çš„ fork ä»“åº“é¡µé¢
2. **åˆ›å»º PR**: ç‚¹å‡» "Compare & pull request"
3. **å¡«å†™ä¿¡æ¯**: 
   - æ ‡é¢˜: `feat: add my_asr_extension for [ä¾›åº”å•†åç§°] ASR service`
   - æè¿°: è¯¦ç»†è¯´æ˜æ‰©å±•åŠŸèƒ½ã€æ”¯æŒçš„ç‰¹æ€§å’Œæµ‹è¯•æƒ…å†µ
4. **æäº¤ PR**: ç­‰å¾…ä»£ç å®¡æŸ¥å’Œåˆå¹¶

#### 3. ä»£ç å®¡æŸ¥å’Œåˆå¹¶

- **è‡ªåŠ¨æµ‹è¯•**: CI/CD ç³»ç»Ÿä¼šè‡ªåŠ¨è¿è¡Œæµ‹è¯•
- **ä»£ç å®¡æŸ¥**: ç»´æŠ¤è€…ä¼šå®¡æŸ¥ä»£ç è´¨é‡å’ŒåŠŸèƒ½
- **ä¿®æ”¹å»ºè®®**: æ ¹æ®åé¦ˆè¿›è¡Œå¿…è¦çš„ä¿®æ”¹
- **åˆå¹¶**: é€šè¿‡å®¡æŸ¥åï¼Œä»£ç ä¼šè¢«åˆå¹¶åˆ° main åˆ†æ”¯

#### 4. è‡ªåŠ¨å‘å¸ƒåˆ° TEN Store

ä¸€æ—¦ä½ çš„ PR è¢«åˆå¹¶åˆ° main åˆ†æ”¯ï¼š

- âœ… **è‡ªåŠ¨ä¸Šä¼ **: æ‰©å±•ä¼šè‡ªåŠ¨ä¸Šä¼ åˆ° TEN Store
- âœ… **ç‰ˆæœ¬ç®¡ç†**: ç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†ç‰ˆæœ¬å·å’Œå‘å¸ƒæµç¨‹
- âœ… **å…¨çƒå¯ç”¨**: ä½ çš„æ‰©å±•ç«‹å³å¯ä¾›å…¨çƒå¼€å‘è€…ä¸‹è½½ä½¿ç”¨

#### 5. ä½¿ç”¨ä½ çš„æ‰©å±•

å…¶ä»–å¼€å‘è€…ç°åœ¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ä½¿ç”¨ä½ çš„æ‰©å±•ï¼š

```bash title="Terminal"
# å®‰è£…ä½ çš„ ASR æ‰©å±•
tman install extension my_asr_extension

# æˆ–è€…åœ¨é¡¹ç›®ä¸­å£°æ˜ä¾èµ–
```

```json title="manifest.json"
{
  "dependencies": [
    {
      "type": "extension",
      "name": "my_asr_extension",
      "version": "^1.0.0"
    }
  ]
}
```

#### å‘å¸ƒæ³¨æ„äº‹é¡¹

- **æ‰©å±•å‘½å**: ä½¿ç”¨æè¿°æ€§çš„åç§°ï¼Œé¿å…ä¸ç°æœ‰æ‰©å±•å†²çª
- **ç‰ˆæœ¬å…¼å®¹æ€§**: ç¡®ä¿ä¸å½“å‰ TEN Framework ç‰ˆæœ¬å…¼å®¹
- **è®¸å¯è¯**: æ˜ç¡®æ‰©å±•çš„å¼€æºè®¸å¯è¯
- **ç»´æŠ¤æ‰¿è¯º**: å‡†å¤‡å¥½ç»´æŠ¤å’Œæ›´æ–°ä½ çš„æ‰©å±•

## ğŸ“š æ€»ç»“

æ­å–œä½ å®Œæˆäº† ASR æ‰©å±•å¼€å‘çš„å®Œæ•´å­¦ä¹ ä¹‹æ—…ï¼

### ğŸ¯ æŒæ¡çš„æ ¸å¿ƒæŠ€èƒ½

- âœ… **é¡¹ç›®æ­å»º**: ä½¿ç”¨ ASR æ¨¡æ¿å¿«é€Ÿåˆ›å»ºé¡¹ç›®éª¨æ¶
- âœ… **æ¶æ„è®¾è®¡**: æ·±å…¥ç†è§£ ASR Extension æ¥å£è§„èŒƒå’Œ
- âœ… **åŠŸèƒ½å¼€å‘**: å®ç°è¿æ¥ç®¡ç†ã€éŸ³é¢‘å¤„ç†ã€äº‹ä»¶å¤„ç†ç­‰æ ¸å¿ƒåŠŸèƒ½
- âœ… **é«˜çº§ç‰¹æ€§**: é›†æˆé‡è¿æœºåˆ¶ã€éŸ³é¢‘è°ƒè¯•ã€æŒ‡æ ‡ä¸ŠæŠ¥ç­‰é«˜çº§ç‰¹æ€§
- âœ… **è´¨é‡ä¿è¯**: ç¼–å†™å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€ç«¯åˆ°ç«¯æµ‹è¯•çš„å®Œæ•´è¦†ç›–
- âœ… **ç”Ÿäº§å°±ç»ª**: æŒæ¡æ—¥å¿—è®°å½•ã€é”™è¯¯å¤„ç†ã€æ€§èƒ½ä¼˜åŒ–ç­‰æœ€ä½³å®è·µ

### ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

ç°åœ¨ä½ å¯ä»¥ï¼š

1. **å®è·µåº”ç”¨**: é€‰æ‹©ä½ ç†Ÿæ‚‰çš„ ASR æœåŠ¡å•†ï¼Œåˆ›å»ºè‡ªå·±çš„æ‰©å±•
2. **æ·±å…¥å­¦ä¹ **: ç ”ç©¶å…¶ä»– TEN æ‰©å±•ç±»å‹ï¼ˆTTSã€LLMç­‰ï¼‰çš„å®ç°æ¨¡å¼  
3. **è´¡çŒ®ç¤¾åŒº**: æäº¤ PR åˆ° TEN Frameworkï¼Œåˆ†äº«ä½ çš„æˆæœ
4. **ç”Ÿæ€å»ºè®¾**: å‘å¸ƒåˆ° TEN Storeï¼Œè®©æ›´å¤šå¼€å‘è€…å—ç›Š

<Callout type="success">
  **å¼€å‘æ„‰å¿«ï¼** å¦‚æœåœ¨å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œæ¬¢è¿åœ¨ [TEN Framework GitHub](https://github.com/TEN-framework/TEN-Agent) ä¸Šæ Issue æˆ–å‚ä¸è®¨è®ºã€‚
</Callout>

<Callout title="ä¸‹ä¸€æ­¥">
  æ¨èé˜…è¯» [TTS æ‰©å±•å¼€å‘æŒ‡å—] å’Œ [LLM æ‰©å±•å¼€å‘æŒ‡å—]ï¼ŒæŒæ¡å®Œæ•´çš„ AI Agent æ‰©å±•å¼€å‘æŠ€èƒ½ã€‚
</Callout>
